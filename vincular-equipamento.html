<!DOCTYPE html>
<html class="light" lang="pt-BR"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport"/>
<title>Vincular Equipamento - Ondeline</title>
<!-- PWA Meta Tags -->
<meta name="theme-color" content="#135bec"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Ondeline Tech"/>
<link rel="manifest" href="manifest.json"/>
<link rel="icon" type="image/png" href="logo.png"/>
<link rel="apple-touch-icon" href="logo.png"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script id="tailwind-config">
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#135bec",
                    "background-light": "#f6f6f8",
                    "background-dark": "#101622",
                },
                fontFamily: {
                    "display": ["Inter"]
                },
                borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
            },
        },
    }
</script>
<style>
    .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    body {
        min-height: 100dvh;
    }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
<div class="relative flex h-auto min-h-screen w-full flex-col bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden">
    <!-- Header -->
    <div class="flex items-center bg-white dark:bg-background-dark p-4 pb-2 justify-between border-b border-gray-100 dark:border-gray-800 sticky top-0 z-30">
        <div class="text-[#111318] dark:text-white flex size-12 shrink-0 items-center cursor-pointer" onclick="window.history.back()">
            <span class="material-symbols-outlined">arrow_back_ios</span>
        </div>
        <h2 class="text-[#111318] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">Vincular Equipamento</h2>
        <div class="size-12"></div>
    </div>

    <div class="flex flex-col gap-4 p-4 pb-32">
        <!-- Ícone ilustrativo -->
        <div class="flex flex-col items-center py-8">
            <div class="size-24 rounded-full bg-purple-50 dark:bg-purple-500/10 flex items-center justify-center mb-4">
                <span class="material-symbols-outlined text-5xl text-purple-600" style="font-variation-settings: 'FILL' 1">router</span>
            </div>
            <h3 class="text-[#111318] dark:text-white text-xl font-bold">Vincular Roteador</h3>
            <p class="text-[#616f89] text-sm text-center mt-2 max-w-xs">Insira o número de série do equipamento e selecione o cliente para vincular.</p>
        </div>

        <!-- Campo Serial -->
        <div class="bg-white dark:bg-background-dark rounded-xl border border-gray-100 dark:border-gray-800 p-4">
            <h3 class="text-[#111318] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] pb-4">Dados do Equipamento</h3>
            
            <label class="flex flex-col">
                <p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-2">Número de Série</p>
                <div class="relative">
                    <input id="field-serial" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary h-14 placeholder:text-[#94a3b8] px-4 pr-12 text-base font-mono font-medium leading-normal uppercase" placeholder="Ex: SN123456789" type="text" value="" required/>
                    <button id="btn-scan" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        <span class="material-symbols-outlined text-xl">qr_code_scanner</span>
                    </button>
                </div>
                <p class="text-[#616f89] text-xs mt-2">Digite ou escaneie o código de barras/QR do equipamento</p>
            </label>
            
            <!-- Motivo da Troca -->
            <label class="flex flex-col mt-4">
                <p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-2">Motivo da Troca</p>
                <select id="field-reason" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary h-12 text-base font-normal leading-normal">
                    <option value="other">Selecione um motivo</option>
                    <option value="defect">Defeito no equipamento</option>
                    <option value="upgrade">Upgrade de equipamento</option>
                    <option value="transfer">Transferência de unidade</option>
                    <option value="theft">Roubo ou furto</option>
                    <option value="other">Outro motivo</option>
                </select>
            </label>
            
            <label class="flex flex-col mt-4">
                <p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-2">Descrição do Motivo (opcional)</p>
                <textarea id="field-reason-desc" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary min-h-[80px] px-4 py-3 text-base font-normal leading-normal" placeholder="Descreva mais detalhes sobre a troca..."></textarea>
            </label>
        </div>

        <!-- Busca de Cliente -->
        <div class="bg-white dark:bg-background-dark rounded-xl border border-gray-100 dark:border-gray-800 p-4">
            <h3 class="text-[#111318] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] pb-4">Selecionar Cliente</h3>
            
            <label class="flex flex-col mb-4">
                <p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-2">Buscar por Nome ou CPF</p>
                <div class="relative">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                    <input id="field-search" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary h-12 placeholder:text-[#94a3b8] pl-10 pr-4 text-base font-normal leading-normal" placeholder="Digite o nome ou CPF do cliente" type="text" value=""/>
                </div>
            </label>

            <!-- Lista de resultados da busca -->
            <div id="search-results" class="space-y-2 max-h-64 overflow-y-auto hidden">
                <!-- Resultados serão inseridos aqui via JS -->
            </div>

            <!-- Cliente selecionado -->
            <div id="selected-client" class="hidden mt-4 p-4 rounded-xl bg-green-50 dark:bg-green-500/10 border border-green-200 dark:border-green-500/30">
                <div class="flex items-center gap-3">
                    <div class="size-12 rounded-full bg-green-100 dark:bg-green-500/20 flex items-center justify-center">
                        <span class="material-symbols-outlined text-green-600">person</span>
                    </div>
                    <div class="flex-1">
                        <p id="selected-name" class="text-[#111318] dark:text-white font-semibold"></p>
                        <p id="selected-cpf" class="text-[#616f89] text-sm"></p>
                        <p id="selected-address" class="text-[#616f89] text-xs mt-1"></p>
                    </div>
                    <button id="btn-clear-selection" class="p-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-600">
                        <span class="material-symbols-outlined text-lg">close</span>
                    </button>
                </div>
                <!-- Serial atual do cliente (se houver) -->
                <div id="current-serial-container" class="hidden mt-3 pt-3 border-t border-green-200 dark:border-green-500/30">
                    <p class="text-xs text-orange-600 dark:text-orange-400 font-medium flex items-center gap-1">
                        <span class="material-symbols-outlined text-sm">warning</span>
                        Equipamento atual: <span id="current-serial" class="font-mono"></span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Info Box -->
        <div class="bg-blue-50 dark:bg-blue-500/10 rounded-xl p-4 flex items-start gap-3">
            <span class="material-symbols-outlined text-blue-600 mt-0.5">info</span>
            <div>
                <p class="text-blue-800 dark:text-blue-300 text-sm font-medium">Dica</p>
                <p class="text-blue-600 dark:text-blue-400 text-xs mt-1">Verifique se o número de série está correto antes de vincular. Esta ação substituirá o equipamento anterior do cliente.</p>
            </div>
        </div>
    </div>

    <!-- Botão Vincular fixo -->
    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/80 dark:bg-background-dark/80 backdrop-blur-md border-t border-gray-100 dark:border-gray-800 flex justify-center items-center z-40">
        <button id="btn-vincular" disabled class="w-full max-w-[480px] bg-primary hover:bg-primary/90 disabled:bg-gray-300 dark:disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 active:scale-[0.97]">
            <span class="material-symbols-outlined">link</span>
            Vincular Equipamento
        </button>
    </div>
</div>

<!-- Scripts do App -->
<script src="js/api.js"></script>
<script src="js/app.js"></script>
<script src="js/feedback.js"></script>
<script>
    // Script de backup para vincular equipamento
    var selectedClient = null;
    
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('=== Vincular Equipamento Iniciado ===');
        
        // Registra o acesso à página de vincular equipamento no log de auditoria
        logPageAccess('link_equipment_page', 'Acessou página de vincular equipamento');
        
        var searchInput = document.getElementById('field-search');
        var searchResults = document.getElementById('search-results');
        var serialInput = document.getElementById('field-serial');
        var btnVincular = document.getElementById('btn-vincular');
        var selectedClientDiv = document.getElementById('selected-client');
        var btnClearSelection = document.getElementById('btn-clear-selection');
        
        console.log('Elementos encontrados:', {
            searchInput: !!searchInput,
            searchResults: !!searchResults,
            serialInput: !!serialInput,
            btnVincular: !!btnVincular
        });
        
        var searchTimeout;
        
        // Verifica token
        var token = localStorage.getItem('auth_token');
        console.log('Token presente:', !!token);
        if (!token) {
            console.warn('AVISO: Token não encontrado! Usuário pode não estar logado.');
        }
        
        // Busca de clientes
        if (searchInput) {
            console.log('Adicionando listener de busca...');
            
            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                var query = e.target.value.trim();
                console.log('Input detectado:', query);
                
                if (query.length < 2) {
                    searchResults.classList.add('hidden');
                    searchResults.innerHTML = '';
                    return;
                }
                
                // Mostra loading
                searchResults.innerHTML = '<div class="p-4 text-center text-gray-500"><span class="material-symbols-outlined animate-spin">sync</span> Buscando...</div>';
                searchResults.classList.remove('hidden');
                
                searchTimeout = setTimeout(async function() {
                    console.log('Iniciando busca por:', query);
                    
                    try {
                        // Usa endpoint de busca com autenticação para filtro por cidade
                        var url = '/api/search-clients.php?search=' + encodeURIComponent(query) + '&limit=10';
                        console.log('URL da requisição:', url);

                        var fetchOptions = {};
                        if (token) {
                            fetchOptions.headers = { 'Authorization': 'Bearer ' + token };
                        }
                        var response = await fetch(url, fetchOptions);
                        console.log('Status da resposta:', response.status);
                        
                        var responseText = await response.text();
                        console.log('Resposta raw:', responseText);
                        
                        var result;
                        try {
                            result = JSON.parse(responseText);
                        } catch (parseError) {
                            console.error('Erro ao parsear JSON:', parseError);
                            searchResults.innerHTML = '<div class="p-4 text-center text-red-500">Erro: Resposta inválida do servidor</div>';
                            return;
                        }
                        
                        console.log('Resultado parseado:', result);
                        
                        if (result.success && result.data && result.data.length > 0) {
                            console.log('Encontrados', result.data.length, 'clientes');
                            
                            searchResults.innerHTML = result.data.map(function(client) {
                                var cpfFormatado = formatCPF(client.cpf || '');
                                var endereco = (client.address || '') + ', ' + (client.number || '') + ' - ' + (client.city || '');
                                
                                return '<div class="client-item p-3 rounded-lg bg-gray-50 dark:bg-gray-800 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-3 mb-2" ' +
                                    'data-cpf="' + (client.cpf || '') + '" ' +
                                    'data-name="' + (client.name || '').replace(/"/g, '&quot;') + '" ' +
                                    'data-address="' + endereco.replace(/"/g, '&quot;') + '" ' +
                                    'data-serial="' + (client.serial || '') + '">' +
                                    '<div class="size-10 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center">' +
                                        '<span class="material-symbols-outlined text-blue-600 dark:text-blue-400">person</span>' +
                                    '</div>' +
                                    '<div class="flex-1 min-w-0">' +
                                        '<p class="font-medium text-gray-900 dark:text-white truncate">' + (client.name || 'Sem nome') + '</p>' +
                                        '<p class="text-xs text-gray-500 dark:text-gray-400">' + cpfFormatado + '</p>' +
                                    '</div>' +
                                    (client.serial ? '<span class="material-symbols-outlined text-orange-500" title="Já possui equipamento">router</span>' : '') +
                                '</div>';
                            }).join('');
                            
                            // Adiciona eventos de clique
                            searchResults.querySelectorAll('.client-item').forEach(function(el) {
                                el.onclick = function() {
                                    selectClient({
                                        cpf: el.dataset.cpf,
                                        name: el.dataset.name,
                                        address: el.dataset.address,
                                        serial: el.dataset.serial
                                    });
                                };
                            });
                        } else if (result.success && (!result.data || result.data.length === 0)) {
                            console.log('Nenhum cliente encontrado');
                            searchResults.innerHTML = '<div class="p-4 text-center text-gray-500"><span class="material-symbols-outlined text-2xl mb-2">search_off</span><br>Nenhum cliente encontrado</div>';
                        } else {
                            console.error('Erro na resposta:', result.message);
                            searchResults.innerHTML = '<div class="p-4 text-center text-red-500">Erro: ' + (result.message || 'Erro desconhecido') + '</div>';
                        }
                    } catch (error) {
                        console.error('Erro na busca:', error);
                        searchResults.innerHTML = '<div class="p-4 text-center text-red-500">Erro de conexão: ' + error.message + '</div>';
                    }
                }, 400);
            });
        } else {
            console.error('ERRO: Campo de busca não encontrado!');
        }
        
        // Selecionar cliente
        function selectClient(client) {
            console.log('Cliente selecionado:', client);
            selectedClient = client;
            
            document.getElementById('selected-name').textContent = client.name || 'Sem nome';
            document.getElementById('selected-cpf').textContent = formatCPF(client.cpf || '');
            document.getElementById('selected-address').textContent = client.address || 'Endereço não informado';
            
            var currentSerialContainer = document.getElementById('current-serial-container');
            if (client.serial && client.serial.trim()) {
                document.getElementById('current-serial').textContent = client.serial;
                currentSerialContainer.classList.remove('hidden');
            } else {
                currentSerialContainer.classList.add('hidden');
            }
            
            searchResults.classList.add('hidden');
            selectedClientDiv.classList.remove('hidden');
            searchInput.disabled = true;
            
            checkButton();
        }
        
        // Limpar seleção
        if (btnClearSelection) {
            btnClearSelection.onclick = function() {
                console.log('Limpando seleção');
                selectedClient = null;
                selectedClientDiv.classList.add('hidden');
                searchInput.value = '';
                searchInput.disabled = false;
                searchInput.focus();
                checkButton();
            };
        }
        
        // Serial input
        if (serialInput) {
            serialInput.addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
                checkButton();
            });
        }
        
        // Verificar se pode habilitar botão
        function checkButton() {
            var hasSerial = serialInput && serialInput.value.trim().length >= 3;
            var hasClient = selectedClient !== null;
            btnVincular.disabled = !(hasSerial && hasClient);
            console.log('Check button:', { hasSerial: hasSerial, hasClient: hasClient, disabled: btnVincular.disabled });
        }
        
        // Vincular
        if (btnVincular) {
            btnVincular.onclick = async function() {
                if (!selectedClient || !serialInput.value.trim()) {
                    showError('Preencha todos os campos');
                    return;
                }
                
                var reason = document.getElementById('field-reason').value;
                var reasonDesc = document.getElementById('field-reason-desc').value;
                
                if (reason === 'other' && !reasonDesc.trim()) {
                    showWarning('Por favor, descreva o motivo da troca');
                    return;
                }
                
                console.log('Vinculando equipamento...');
                btnVincular.disabled = true;
                btnVincular.innerHTML = '<span class="material-symbols-outlined animate-spin">sync</span> Vinculando...';
                
                try {
                    var payload = {
                        cpf: selectedClient.cpf,
                        serial: serialInput.value.trim().toUpperCase(),
                        reason: reason,
                        reason_description: reasonDesc
                    };
                    
                    // Verifica se está offline
                    if (!navigator.onLine) {
                        saveOffline('link_equipment', payload);
                        showSuccess('Equipamento salvo offline! Será sincronizado quando reconectar.');
                        setTimeout(function() {
                            window.location.href = 'dashboard.html';
                        }, 2000);
                        return;
                    }
                    
                    var response = await fetch('/api/vincular.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + (token || '')
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    var result = await response.json();
                    console.log('Resultado vincular:', result);
                    
                    if (result.success) {
                        showSuccess('Equipamento vinculado com sucesso!');
                        setTimeout(function() {
                            window.location.href = 'dashboard.html';
                        }, 1000);
                    } else {
                        showError('Erro: ' + (result.message || 'Erro desconhecido'));
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    
                    // Salva offline se falhar
                    if (!navigator.onLine) {
                        saveOffline('link_equipment', payload);
                        showSuccess('Salvo offline! Será sincronizado quando reconectar.');
                        setTimeout(function() {
                            window.location.href = 'dashboard.html';
                        }, 2000);
                    } else {
                        showError('Erro ao vincular: ' + error.message);
                    }
                } finally {
                    btnVincular.disabled = false;
                    btnVincular.innerHTML = '<span class="material-symbols-outlined">link</span> Vincular Equipamento';
                    checkButton();
                }
            };
        }
        
        // Formatar CPF
        function formatCPF(cpf) {
            if (!cpf) return '';
            cpf = cpf.toString().replace(/\D/g, '');
            if (cpf.length !== 11) return cpf;
            return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }
        
        console.log('=== Inicialização concluída ===');
    });

    // Registra acesso à página no log de auditoria
    async function logPageAccess(actionType, actionDescription) {
        try {
            var token = localStorage.getItem('authToken');
            if (!token) return;
            
            await fetch('/api/audit-log.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({
                    action_type: actionType,
                    action_description: actionDescription,
                    entity_type: 'page',
                    entity_id: 'vincular-equipamento.html',
                    entity_name: 'Página de Vincular Equipamento'
                })
            });
        } catch (error) {
            console.error('Erro ao registrar acesso:', error);
        }
    }
</script>
</body></html>
