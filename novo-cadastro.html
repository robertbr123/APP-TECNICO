<!DOCTYPE html>
<html class="light" lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport"/>
<title>Novo Cadastro de Cliente - Ondeline</title>
<meta name="theme-color" content="#135bec"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Ondeline Tech"/>
<link rel="manifest" href="manifest.json"/>
<link rel="icon" type="image/png" href="logo.png"/>
<link rel="apple-touch-icon" href="logo.png"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script>
tailwind.config = {
    darkMode: "class",
    theme: {
        extend: {
            colors: {
                "primary": "#135bec",
                "background-light": "#f6f6f8",
                "background-dark": "#101622",
            },
            fontFamily: {
                "display": ["Inter"]
            },
            borderRadius: { 
                "DEFAULT": "0.25rem", 
                "lg": "0.5rem", 
                "xl": "0.75rem", 
                "full": "9999px" 
            },
        },
    },
}
</script>
<style>
    .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    body {
        min-height: 100dvh;
    }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
<div class="relative flex h-auto min-h-screen w-full flex-col bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden">
<div class="flex items-center bg-white dark:bg-background-dark p-4 pb-2 justify-between border-b border-gray-100 dark:border-gray-800 sticky top-0 z-30">
<div class="text-[#111318] dark:text-white flex size-12 shrink-0 items-center cursor-pointer" onclick="window.history.back()">
<span class="material-symbols-outlined">arrow_back_ios</span>
</div>
<h2 class="text-[#111318] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">Novo Cadastro</h2>
<div class="size-12"></div>
</div>

<div class="flex flex-col gap-2 pb-32">
<div class="bg-white dark:bg-background-dark mt-2 border-b border-gray-50 dark:border-gray-900">
<h3 class="text-[#111318] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-6">Dados Pessoais</h3>
<div class="flex max-w-full flex-wrap items-end gap-4 px-4 py-3">
<label class="flex flex-col min-w-40 flex-1">
<p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-1">Nome Completo</p>
<input id="field-name" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary h-12 placeholder:text-[#94a3b8] px-4 text-base font-normal leading-normal" placeholder="Ex: Jo√£o da Silva" type="text" value="" required/>
</label>
</div>
<div class="flex max-w-full flex-wrap items-end gap-4 px-4 py-3">
<label class="flex flex-col min-w-[140px] flex-1">
<p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-1">CPF</p>
<input id="field-cpf" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary h-12 placeholder:text-[#94a3b8] px-4 text-base font-normal leading-normal" placeholder="000.000.000-00" type="text" value="" required/>
</label>
<label class="flex flex-col min-w-[140px] flex-1">
<p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-1">Telefone</p>
<input id="field-phone" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary h-12 placeholder:text-[#94a3b8] px-4 text-base font-normal leading-normal" placeholder="(00) 00000-0000" type="tel" value="" required/>
</label>
</div>
<div class="flex max-w-full flex-wrap items-end gap-4 px-4 py-3">
<label class="flex flex-col min-w-[140px] flex-1">
<p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-1">Data de Nascimento</p>
<input id="field-dob" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary h-12 placeholder:text-[#94a3b8] px-4 text-base font-normal leading-normal" type="date" value=""/>
</label>
</div>
<div class="h-4"></div>
</div>

<div class="bg-white dark:bg-background-dark border-b border-gray-50 dark:border-gray-900">
<h3 class="text-[#111318] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-6">Endere√ßo</h3>
<div class="flex max-w-full flex-wrap items-end gap-4 px-4 py-3">
<label class="flex flex-col min-w-[120px] w-1/3">
<p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-1">CEP</p>
<input id="field-cep" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary h-12 placeholder:text-[#94a3b8] px-4 text-base font-normal leading-normal" placeholder="00000-000" type="text" value=""/>
</label>
<label class="flex flex-col min-w-[160px] flex-1">
<p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-1">Cidade</p>
<input id="field-city" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary h-12 placeholder:text-[#94a3b8] px-4 text-base font-normal leading-normal" placeholder="Cidade" type="text" value="" required/>
</label>
</div>
<div class="flex max-w-full flex-wrap items-end gap-4 px-4 py-3">
<label class="flex flex-col min-w-40 flex-1">
<p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-1">Rua</p>
<input id="field-street" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary h-12 placeholder:text-[#94a3b8] px-4 text-base font-normal leading-normal" placeholder="Nome da Rua" type="text" value=""/>
</label>
</div>
<div class="flex max-w-full flex-wrap items-end gap-4 px-4 py-3">
<label class="flex flex-col min-w-[80px] w-1/4">
<p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-1">N√∫mero</p>
<input id="field-number" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary h-12 placeholder:text-[#94a3b8] px-4 text-base font-normal leading-normal" placeholder="123" type="text" value=""/>
</label>
<label class="flex flex-col min-w-[160px] flex-1">
<p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-1">Complemento</p>
<input id="field-complement" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary h-12 placeholder:text-[#94a3b8] px-4 text-base font-normal leading-normal" placeholder="Ap, Bloco, etc." type="text" value=""/>
</label>
</div>
<button id="btn-location" class="mx-4 my-3 flex items-center justify-center gap-2 py-3 px-4 rounded-xl bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors font-medium">
<span class="material-symbols-outlined">location_on</span>
<span>Obter Minha Localiza√ß√£o</span>
</button>
<div class="h-4"></div>
</div>

<div class="bg-white dark:bg-background-dark border-b border-gray-50 dark:border-gray-900">
<h3 class="text-[#111318] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-6">Dados do Plano</h3>
<div class="flex max-w-full flex-wrap items-end gap-4 px-4 py-3">
<label class="flex flex-col min-w-40 flex-1">
<p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-1">Plano</p>
<select id="field-plan" class="form-select flex w-full min-w-0 flex-1 rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary h-12 px-4 text-base font-normal leading-normal">
<option value="6">Plano B√°sico - R$ 130</option>
<option value="7">Plano 100 - R$ 100</option>
<option value="9">Plano Intermedi√°rio - R$ 150</option>
<option value="8">Plano Avan√ßado - R$ 180</option>
</select>
</label>
</div>
<div class="flex max-w-full flex-wrap items-end gap-4 px-4 py-3">
<label class="flex flex-col min-w-40 flex-1">
<p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-1">Usu√°rio PPPoE</p>
<input id="field-pppoe-user" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary h-12 placeholder:text-[#94a3b8] px-4 text-base font-normal leading-normal" placeholder="usuario@ondeline" type="text" value=""/>
</label>
</div>
<div class="flex max-w-full flex-wrap items-end gap-4 px-4 py-3">
<label class="flex flex-col min-w-[140px] flex-1">
<p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-1">Senha PPPoE</p>
<input id="field-pppoe-pass" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary h-12 placeholder:text-[#94a3b8] px-4 text-base font-normal leading-normal" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" type="password" value=""/>
</label>
<label class="flex flex-col min-w-[120px] w-1/3">
<p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-1">Vencimento</p>
<select id="field-due-date" class="form-select flex w-full min-w-0 flex-1 rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary h-12 px-4 text-base font-normal leading-normal">
<option value="10">Dia 10</option>
<option value="20">Dia 20</option>
<option value="30">Dia 30</option>
</select>
</label>
</div>
<div class="h-4"></div>
</div>

<div class="bg-white dark:bg-background-dark border-b border-gray-50 dark:border-gray-900">
<h3 class="text-[#111318] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-6">Observa√ß√µes</h3>
<div class="flex max-w-full flex-wrap items-end gap-4 px-4 py-3">
<label class="flex flex-col min-w-40 flex-1">
<p class="text-[#111318] dark:text-gray-300 text-sm font-semibold leading-normal pb-1">Coment√°rios Adicionais</p>
<textarea id="field-observations" class="form-textarea flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111318] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#dbdfe6] dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary min-h-[100px] placeholder:text-[#94a3b8] p-4 text-base font-normal leading-normal" placeholder="Observa√ß√µes t√©cnicas, detalhes de acesso, etc."></textarea>
</label>
</div>
<div class="h-4"></div>
</div>

<div class="bg-white dark:bg-background-dark">
<h3 class="text-[#111318] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-6">Fotos da Instala√ß√£o</h3>
<p class="text-[#616f89] text-xs px-4 pb-2">Toque para tirar foto ou selecionar da galeria</p>
<div class="grid grid-cols-2 gap-4 px-4 py-4">
<div class="flex flex-col gap-2">
<p class="text-[#111318] dark:text-gray-300 text-xs font-semibold uppercase tracking-wider leading-tight">Roteador</p>
<div class="photo-upload relative aspect-square w-full rounded-xl border-2 border-dashed border-[#dbdfe6] dark:border-gray-700 bg-gray-50 dark:bg-gray-800 flex flex-col items-center justify-center cursor-pointer active:scale-[0.98] transition-transform overflow-hidden" data-type="router">
<input type="file" accept="image/*" capture="environment" class="absolute inset-0 opacity-0 cursor-pointer z-10">
<span class="material-symbols-outlined text-[#616f89] text-3xl photo-icon">photo_camera</span>
<img class="photo-preview absolute inset-0 w-full h-full object-cover hidden">
<div class="absolute bottom-2 right-2 bg-primary text-white rounded-full size-7 flex items-center justify-center shadow-md photo-add-btn">
<span class="material-symbols-outlined text-lg">add</span>
</div>
<button class="photo-remove-btn absolute top-2 right-2 bg-red-500 text-white rounded-full size-7 items-center justify-center shadow-md hidden">
<span class="material-symbols-outlined text-lg">close</span>
</button>
</div>
</div>
<div class="flex flex-col gap-2">
<p class="text-[#111318] dark:text-gray-300 text-xs font-semibold uppercase tracking-wider leading-tight">Cabeamento</p>
<div class="photo-upload relative aspect-square w-full rounded-xl border-2 border-dashed border-[#dbdfe6] dark:border-gray-700 bg-gray-50 dark:bg-gray-800 flex flex-col items-center justify-center cursor-pointer active:scale-[0.98] transition-transform overflow-hidden" data-type="cabling">
<input type="file" accept="image/*" capture="environment" class="absolute inset-0 opacity-0 cursor-pointer z-10">
<span class="material-symbols-outlined text-[#616f89] text-3xl photo-icon">router</span>
<img class="photo-preview absolute inset-0 w-full h-full object-cover hidden">
<div class="absolute bottom-2 right-2 bg-primary text-white rounded-full size-7 flex items-center justify-center shadow-md photo-add-btn">
<span class="material-symbols-outlined text-lg">add</span>
</div>
<button class="photo-remove-btn absolute top-2 right-2 bg-red-500 text-white rounded-full size-7 items-center justify-center shadow-md hidden">
<span class="material-symbols-outlined text-lg">close</span>
</button>
</div>
</div>
<div class="flex flex-col gap-2">
<p class="text-[#111318] dark:text-gray-300 text-xs font-semibold uppercase tracking-wider leading-tight">Teste de Sinal</p>
<div class="photo-upload relative aspect-square w-full rounded-xl border-2 border-dashed border-[#dbdfe6] dark:border-gray-700 bg-gray-50 dark:bg-gray-800 flex flex-col items-center justify-center cursor-pointer active:scale-[0.98] transition-transform overflow-hidden" data-type="signal">
<input type="file" accept="image/*" capture="environment" class="absolute inset-0 opacity-0 cursor-pointer z-10">
<span class="material-symbols-outlined text-[#616f89] text-3xl photo-icon">speed</span>
<img class="photo-preview absolute inset-0 w-full h-full object-cover hidden">
<div class="absolute bottom-2 right-2 bg-primary text-white rounded-full size-7 flex items-center justify-center shadow-md photo-add-btn">
<span class="material-symbols-outlined text-lg">add</span>
</div>
<button class="photo-remove-btn absolute top-2 right-2 bg-red-500 text-white rounded-full size-7 items-center justify-center shadow-md hidden">
<span class="material-symbols-outlined text-lg">close</span>
</button>
</div>
</div>
<div class="flex flex-col gap-2">
<p class="text-[#111318] dark:text-gray-300 text-xs font-semibold uppercase tracking-wider leading-tight">Outros</p>
<div class="photo-upload relative aspect-square w-full rounded-xl border-2 border-dashed border-[#dbdfe6] dark:border-gray-700 bg-gray-50 dark:bg-gray-800 flex flex-col items-center justify-center cursor-pointer active:scale-[0.98] transition-transform overflow-hidden" data-type="other">
<input type="file" accept="image/*" capture="environment" class="absolute inset-0 opacity-0 cursor-pointer z-10">
<span class="material-symbols-outlined text-[#616f89] text-3xl photo-icon">add_a_photo</span>
<img class="photo-preview absolute inset-0 w-full h-full object-cover hidden">
<div class="absolute bottom-2 right-2 bg-primary text-white rounded-full size-7 flex items-center justify-center shadow-md photo-add-btn">
<span class="material-symbols-outlined text-lg">add</span>
</div>
<button class="photo-remove-btn absolute top-2 right-2 bg-red-500 text-white rounded-full size-7 items-center justify-center shadow-md hidden">
<span class="material-symbols-outlined text-lg">close</span>
</button>
</div>
</div>
</div>
<div class="h-8"></div>
</div>
</div>

<div class="fixed bottom-0 left-0 right-0 p-4 bg-white/80 dark:bg-background-dark/80 backdrop-blur-md border-t border-gray-100 dark:border-gray-800 flex justify-center items-center z-40">
<button id="btn-salvar-cadastro" class="w-full max-w-[480px] bg-primary hover:bg-primary/90 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 active:scale-[0.97]">
<span class="material-symbols-outlined">save</span>
Salvar Cadastro
</button>
</div>
</div>

<!-- Scripts do App -->
<script src="js/api.js"></script>
<script src="js/app.js"></script>
<script src="js/geolocation.js"></script>
<script src="js/feedback.js"></script>

<!-- Campos ocultos para geolocaliza√ß√£o -->
<input type="hidden" id="field-latitude" name="latitude">
<input type="hidden" id="field-longitude" name="longitude">
<input type="hidden" id="field-accuracy" name="accuracy">

<script>
// Armazena as fotos selecionadas
var selectedPhotos = {
    router: null,
    cabling: null,
    signal: null,
    other: null
};

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM carregado');
    
    // Registra o acesso √† p√°gina de cadastro no log de auditoria
    logPageAccess('new_client_page', 'Acessou p√°gina de novo cadastro');
    
    // Vari√°vel para controlar se a localiza√ß√£o foi obtida
    var locationObtained = false;
    
    // Fun√ß√£o para solicitar localiza√ß√£o
    function requestLocation() {
        if (locationObtained) {
            showInfo('Localiza√ß√£o j√° obtida!');
            return;
        }
        
        if (!navigator.geolocation) {
            showError('Geolocaliza√ß√£o n√£o √© suportada neste navegador');
            return;
        }
        
        showInfo('Solicitando permiss√£o de localiza√ß√£o...');
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                var location = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };
                
                document.getElementById('field-latitude').value = location.latitude;
                document.getElementById('field-longitude').value = location.longitude;
                document.getElementById('field-accuracy').value = location.accuracy;
                
                locationObtained = true;
                console.log('Localiza√ß√£o obtida:', location);
                
                // Atualiza bot√£o
                var locBtn = document.getElementById('btn-location');
                if (locBtn) {
                    locBtn.innerHTML = '<span class="material-symbols-outlined">check_circle</span> Localiza√ß√£o OK';
                    locBtn.classList.remove('bg-blue-50', 'text-blue-600');
                    locBtn.classList.add('bg-green-50', 'text-green-600');
                    locBtn.disabled = true;
                }
                
                showSuccess('Localiza√ß√£o obtida com sucesso! üìç');
            },
            function(error) {
                var errorMsg = 'Erro ao obter localiza√ß√£o';
                
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg = 'Permiss√£o de localiza√ß√£o negada. Habilite nas configura√ß√µes do navegador.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg = 'Informa√ß√£o de localiza√ß√£o indispon√≠vel';
                        break;
                    case error.TIMEOUT:
                        errorMsg = 'Tempo esgotado ao obter localiza√ß√£o';
                        break;
                    default:
                        errorMsg = 'Erro desconhecido ao obter localiza√ß√£o';
                }
                
                console.error('Erro de geolocaliza√ß√£o:', error);
                showError(errorMsg + ' O cadastro continuar√° sem localiza√ß√£o.');
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 30000
            }
        );
    }
    
    // Configura bot√£o de localiza√ß√£o
    var locBtn = document.getElementById('btn-location');
    if (locBtn) {
        locBtn.onclick = requestLocation;
    }
    
    // N√ÉO solicita automaticamente - espera o usu√°rio clicar
    console.log('Bot√£o de localiza√ß√£o configurado. Aguardando clique do usu√°rio.');
    
    // Configura os inputs de foto
    document.querySelectorAll('.photo-upload').forEach(function(container) {
        var type = container.dataset.type;
        var input = container.querySelector('input[type="file"]');
        var preview = container.querySelector('.photo-preview');
        var icon = container.querySelector('.photo-icon');
        var addBtn = container.querySelector('.photo-add-btn');
        var removeBtn = container.querySelector('.photo-remove-btn');
        
        if (input) {
            input.addEventListener('change', function(e) {
                var file = e.target.files[0];
                if (file) {
                    console.log('Foto selecionada:', type, file.name);
                    selectedPhotos[type] = file;
                    
                    // Mostra preview
                    var reader = new FileReader();
                    reader.onload = function(ev) {
                        preview.src = ev.target.result;
                        preview.classList.remove('hidden');
                        icon.classList.add('hidden');
                        addBtn.classList.add('hidden');
                        removeBtn.classList.remove('hidden');
                        removeBtn.style.display = 'flex';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        if (removeBtn) {
            removeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Removendo foto:', type);
                selectedPhotos[type] = null;
                input.value = '';
                preview.src = '';
                preview.classList.add('hidden');
                icon.classList.remove('hidden');
                addBtn.classList.remove('hidden');
                removeBtn.classList.add('hidden');
                removeBtn.style.display = 'none';
            });
        }
    });
    
    var btn = document.getElementById('btn-salvar-cadastro');
    console.log('Bot√£o salvar:', btn);
    
    if (btn) {
        btn.onclick = async function(e) {
            e.preventDefault();
            console.log('Bot√£o clicado!');
            
            // Coleta os dados
            var data = {
                name: document.getElementById('field-name')?.value?.trim() || '',
                cpf: document.getElementById('field-cpf')?.value?.trim() || '',
                phone: document.getElementById('field-phone')?.value?.trim() || '',
                birthDate: document.getElementById('field-dob')?.value || '',
                cep: document.getElementById('field-cep')?.value?.trim() || '',
                city: document.getElementById('field-city')?.value?.trim() || '',
                address: document.getElementById('field-street')?.value?.trim() || '',
                number: document.getElementById('field-number')?.value?.trim() || '',
                complement: document.getElementById('field-complement')?.value?.trim() || '',
                planId: parseInt(document.getElementById('field-plan')?.value) || 6,
                pppoe: document.getElementById('field-pppoe-user')?.value?.trim() || '',
                password: document.getElementById('field-pppoe-pass')?.value || '',
                dueDay: parseInt(document.getElementById('field-due-date')?.value) || 10,
                observation: document.getElementById('field-observations')?.value?.trim() || '',
                status: 'ativo',
                active: 1,
                latitude: document.getElementById('field-latitude')?.value || null,
                longitude: document.getElementById('field-longitude')?.value || null,
                accuracy: document.getElementById('field-accuracy')?.value || null
            };
            
            console.log('Dados coletados:', data);
            
            // Valida√ß√£o
            if (!data.name) {
                showError('Preencha o nome do cliente');
                return;
            }
            if (!data.cpf) {
                showError('Preencha o CPF do cliente');
                return;
            }
            
            // Verifica se est√° offline
            if (!navigator.onLine) {
                saveOffline('create_client', data);
                showSuccess('Cliente salvo offline! Ser√° sincronizado quando reconectar.');
                setTimeout(function() {
                    window.location.href = 'dashboard.html';
                }, 2000);
                return;
            }
            
            // Desabilita bot√£o
            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined animate-spin">sync</span> Salvando...';
            
            try {
                // Envia para API de cadastro
                var token = localStorage.getItem('auth_token');
                console.log('Token:', token ? 'Presente' : 'Ausente');
                
                var response = await fetch('/api/cadastro.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (token || '')
                    },
                    body: JSON.stringify(data)
                });
                
                console.log('Status da resposta:', response.status);
                var result = await response.json();
                console.log('Resultado:', result);
                
                if (result.success) {
                    // Cadastro OK, agora envia as fotos
                    var cpfLimpo = data.cpf.replace(/\D/g, '');
                    var fotosEnviadas = 0;
                    var fotosFalha = 0;
                    
                    btn.innerHTML = '<span class="material-symbols-outlined animate-spin">sync</span> Enviando fotos...';
                    
                    for (var type in selectedPhotos) {
                        if (selectedPhotos[type]) {
                            console.log('Enviando foto:', type);
                            try {
                                var formData = new FormData();
                                formData.append('photo', selectedPhotos[type]);
                                formData.append('cpf', cpfLimpo);
                                formData.append('type', type);
                                
                                var uploadResponse = await fetch('/api/upload-foto.php', {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': 'Bearer ' + (token || '')
                                    },
                                    body: formData
                                });
                                
                                var uploadResult = await uploadResponse.json();
                                console.log('Upload', type, ':', uploadResult);
                                
                                if (uploadResult.success) {
                                    fotosEnviadas++;
                                } else {
                                    fotosFalha++;
                                    console.error('Falha upload', type, ':', uploadResult.message);
                                }
                            } catch (uploadError) {
                                fotosFalha++;
                                console.error('Erro upload', type, ':', uploadError);
                            }
                        }
                    }
                    
                    var mensagem = 'Cliente cadastrado com sucesso!';
                    if (fotosEnviadas > 0) {
                        mensagem += ' ' + fotosEnviadas + ' foto(s) enviada(s).';
                    }
                    if (fotosFalha > 0) {
                        mensagem += ' ' + fotosFalha + ' foto(s) falharam.';
                    }
                    
                    showSuccess(mensagem);
                    setTimeout(function() {
                        window.location.href = 'dashboard.html';
                    }, 1000);
                } else {
                    showError('Erro: ' + (result.message || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                
                // Salva offline se falhar
                if (!navigator.onLine) {
                    saveOffline('create_client', data);
                    showSuccess('Salvo offline! Ser√° sincronizado quando reconectar.');
                    setTimeout(function() {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                } else {
                    showError('Erro ao salvar: ' + error.message);
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined">save</span> Salvar Cadastro';
            }
        };
    }
});

// Registra acesso √† p√°gina no log de auditoria
async function logPageAccess(actionType, actionDescription) {
    try {
        var token = localStorage.getItem('authToken');
        if (!token) return;
        
        await fetch('/api/audit-log.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
                action_type: actionType,
                action_description: actionDescription,
                entity_type: 'page',
                entity_id: 'novo-cadastro.html',
                entity_name: 'P√°gina de Novo Cadastro'
            })
        });
    } catch (error) {
        console.error('Erro ao registrar acesso:', error);
    }
}
</script>
</body>
</html>